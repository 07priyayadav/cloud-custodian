#!/bin/bash

acct="sts-digital-dev"

export http_proxy="http://proxy.kdc.capitalone.com:8099/"
export https_proxy=$http_proxy
export no_proxy="*.s3.amazonaws.com 169.254.169.254"

run_date=`date  +%Y-%m-%d--%H-%M`

cache_dir="/var/cache/maid"
log_dir="/var/log/maid"
policy_dir="/etc/maid/policies"

set -ex

for policy in "$@"
do 
    cloud-maid run --dryrun -j -c ${cache_dir}/aws.cache -p 30 -v -c ${policy_dir}/${policy}.yml \
                  -s json 2>> ${log_dir}/${run_date}.log >> ${log_dir}/${run_date}.json
    if [ -s ${log_dir}/${run_date}.json ]
    then
	gzip ${log_dir}/${run_date}.json
	aws s3 cp --sse ${log_dir}/${run_date}.json.gz s3://cloud-maid-${acct}/policies/${policy}/${run_date}.json.gz
    fi
done


