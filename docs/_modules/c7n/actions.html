

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>c7n.actions &mdash; Cloud Custodian  documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/c1_labs.ico"/>
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/css/expand.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Cloud Custodian  documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Cloud Custodian
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/usage.html">Monitoring your environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/advanced.html">Advanced Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/offhours.html">Example offhours policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart/tagCompliance.html">Example tag compliance policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usecases/index.html">Use Cases</a></li>
</ul>
<p class="caption"><span class="caption-text">Working with AWS Lambda</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../policy/lambda.html">Lambda Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../policy/mu.html">Mu - Lambda Lifecycle Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Policies reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../policy/index.html">Resource-Specific Filters and Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filters.html">Generic Filters</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contributing to Cloud Custodian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/installing.html">Installing for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/tests.html">Testing for Developers</a></li>
</ul>
<p class="caption"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../generated/modules.html">c7n</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cloud Custodian</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>c7n.actions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for c7n.actions</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2016 Capital One Services, LLC</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Actions to take on resources</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">jmespath</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">zlib</span>

<span class="kn">from</span> <span class="nn">botocore.exceptions</span> <span class="k">import</span> <span class="n">ClientError</span>

<span class="kn">from</span> <span class="nn">c7n.executor</span> <span class="k">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span> <span class="nn">c7n.registry</span> <span class="k">import</span> <span class="n">PluginRegistry</span>
<span class="kn">from</span> <span class="nn">c7n.resolver</span> <span class="k">import</span> <span class="n">ValuesFrom</span>
<span class="kn">from</span> <span class="nn">c7n</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">c7n.version</span> <span class="k">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">VERSION</span>


<div class="viewcode-block" id="average"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.average">[docs]</a><span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">numbers</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="distinct_count"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.distinct_count">[docs]</a><span class="k">def</span> <span class="nf">distinct_count</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)))</span></div>


<span class="n">METRIC_OPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
    <span class="s1">&#39;distinct_count&#39;</span><span class="p">:</span> <span class="n">distinct_count</span><span class="p">,</span>
    <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span>
    <span class="s1">&#39;average&#39;</span><span class="p">:</span> <span class="n">average</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">METRIC_UNITS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Time</span>
    <span class="s1">&#39;Seconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Microseconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Milliseconds&#39;</span><span class="p">,</span>
    <span class="c1"># Bytes and Bits</span>
    <span class="s1">&#39;Bytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Kilobytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Megabytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gigabytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Terabytes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Bits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Kilobits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Megabits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gigabits&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Terabits&#39;</span><span class="p">,</span>
    <span class="c1"># Rates</span>
    <span class="s1">&#39;Bytes/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Kilobytes/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Megabytes/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gigabytes/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Terabytes/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Bits/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Kilobits/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Megabits/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gigabits/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Terabits/Second&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Count/Second&#39;</span><span class="p">,</span>
    <span class="c1"># Other Scalars</span>
    <span class="s1">&#39;Percent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;None&#39;</span>
<span class="p">]</span>


<div class="viewcode-block" id="ActionRegistry"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.ActionRegistry">[docs]</a><span class="k">class</span> <span class="nc">ActionRegistry</span><span class="p">(</span><span class="n">PluginRegistry</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ActionRegistry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;notify&#39;</span><span class="p">,</span> <span class="n">Notify</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;invoke-lambda&#39;</span><span class="p">,</span> <span class="n">LambdaInvoke</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;put-metric&#39;</span><span class="p">,</span> <span class="n">PutMetric</span><span class="p">)</span>

<div class="viewcode-block" id="ActionRegistry.parse"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.ActionRegistry.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">manager</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ActionRegistry.factory"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.ActionRegistry.factory">[docs]</a>    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">action_type</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">action_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid action type found in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">action_type</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">action_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid action type </span><span class="si">%s</span><span class="s2">, valid actions </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">action_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c1"># Construct a ResourceManager</span>
        <span class="k">return</span> <span class="n">action_class</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Action"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Action">[docs]</a><span class="k">class</span> <span class="nc">Action</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">permissions</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;custodian.actions&quot;</span><span class="p">)</span>

    <span class="n">executor_factory</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_dir</span> <span class="o">=</span> <span class="n">log_dir</span>

<div class="viewcode-block" id="Action.get_permissions"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Action.get_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span></div>

<div class="viewcode-block" id="Action.validate"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Action.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<div class="viewcode-block" id="Action.process"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Action.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Base action class does not implement behavior&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_run_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cmd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ClientError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;Error&#39;</span><span class="p">][</span><span class="s1">&#39;Code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DryRunOperation&#39;</span> <span class="ow">and</span>
            <span class="n">e</span><span class="o">.</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;ResponseMetadata&#39;</span><span class="p">][</span><span class="s1">&#39;HTTPStatusCode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">412</span> <span class="ow">and</span>
            <span class="s1">&#39;would have succeeded&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Dry run operation </span><span class="si">%s</span><span class="s2"> succeeded&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
            <span class="k">raise</span></div>


<span class="n">BaseAction</span> <span class="o">=</span> <span class="n">Action</span>


<div class="viewcode-block" id="ModifyVpcSecurityGroupsAction"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.ModifyVpcSecurityGroupsAction">[docs]</a><span class="k">class</span> <span class="nc">ModifyVpcSecurityGroupsAction</span><span class="p">(</span><span class="n">Action</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Common actions for modifying security groups on a resource</span>

<span class="sd">    Can target either physical groups as a list of group ids or</span>
<span class="sd">    symbolic groups like &#39;matched&#39; or &#39;all&#39;. &#39;matched&#39; uses</span>
<span class="sd">    the annotations of the &#39;security-group&#39; interface filter.</span>

<span class="sd">    Note an interface always gets at least one security group, so</span>
<span class="sd">    we mandate the specification of an isolation/quarantine group</span>
<span class="sd">    that can be specified if there would otherwise be no groups.</span>

<span class="sd">    type: modify-security-groups</span>
<span class="sd">        add: []</span>
<span class="sd">        remove: [] | matched</span>
<span class="sd">        isolation-group: sg-xyz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
        <span class="s1">&#39;additionalProperties&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;modify-security-groups&#39;</span><span class="p">]},</span>
            <span class="s1">&#39;add&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;oneOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;^sg-*&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;^sg-*&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}}]},</span>
            <span class="s1">&#39;remove&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;oneOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;^sg-*&#39;</span><span class="p">}},</span>
                <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;matched&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;^sg-*&#39;</span><span class="p">}]}]},</span>
            <span class="s1">&#39;isolation-group&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;oneOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;^sg-*&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;^sg-*&#39;</span><span class="p">}}]}},</span>
        <span class="s1">&#39;oneOf&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;isolation-group&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;remove&#39;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">]}]</span>
    <span class="p">}</span>

<div class="viewcode-block" id="ModifyVpcSecurityGroupsAction.get_groups"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.ModifyVpcSecurityGroupsAction.get_groups">[docs]</a>    <span class="k">def</span> <span class="nf">get_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">metadata_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse policies to get lists of security groups to attach to each resource</span>

<span class="sd">        For each input resource, parse the various add/remove/isolation-</span>
<span class="sd">        group policies for &#39;modify-security-groups&#39; to find the resulting</span>
<span class="sd">        set of VPC security groups to attach to that resource.</span>

<span class="sd">        The &#39;metadata_key&#39; parameter can be used for two purposes at</span>
<span class="sd">        the moment; The first use is for resources&#39; APIs that return a</span>
<span class="sd">        list of security group IDs but use a different metadata key</span>
<span class="sd">        than &#39;Groups&#39; or &#39;SecurityGroups&#39;.</span>

<span class="sd">        The second use is for when there are richer objects in the &#39;Groups&#39; or</span>
<span class="sd">        &#39;SecurityGroups&#39; lists. The custodian actions need to act on lists of</span>
<span class="sd">        just security group IDs, so the metadata_key can be used to select IDs</span>
<span class="sd">        from the richer objects in the provided lists.</span>

<span class="sd">        Returns a list of lists containing the resulting VPC security groups</span>
<span class="sd">        that should end up on each resource passed in.</span>

<span class="sd">        :param resources: List of resources containing VPC Security Groups</span>
<span class="sd">        :param metadata_key: Metadata key for security groups list</span>
<span class="sd">        :return: List of lists of security groups per resource</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parse the add, remove, and isolation group params to return the</span>
        <span class="c1"># list of security groups that will end up on the resource</span>
        <span class="c1"># target_group_ids = self.data.get(&#39;groups&#39;, &#39;matched&#39;)</span>

        <span class="n">add_target_group_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">remove_target_group_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">isolation_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;isolation-group&#39;</span><span class="p">)</span>
        <span class="n">add_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">remove_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">return_groups</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">resources</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Groups&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">metadata_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;Groups&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">rgroups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">metadata_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rgroups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;GroupId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;Groups&#39;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">metadata_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">rgroups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">metadata_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rgroups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;SecurityGroups&#39;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;VpcSecurityGroups&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">metadata_key</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;VpcSecurityGroups&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">rgroups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">metadata_key</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;VpcSecurityGroups&#39;</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rgroups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;VpcSecurityGroups&#39;</span><span class="p">]]</span>
            <span class="c1"># use as substitution for &#39;Groups&#39; or &#39;[Vpc]SecurityGroups&#39;</span>
            <span class="c1"># unsure if necessary - defer to coverage report</span>
            <span class="k">elif</span> <span class="n">metadata_key</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_key</span><span class="p">):</span>
                <span class="n">rgroups</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">r</span><span class="p">[</span><span class="n">metadata_key</span><span class="p">]]</span>

            <span class="c1"># Parse remove_groups</span>
            <span class="k">if</span> <span class="n">remove_target_group_ids</span> <span class="o">==</span> <span class="s1">&#39;matched&#39;</span><span class="p">:</span>
                <span class="n">remove_groups</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;c7n.matched-security-groups&#39;</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">elif</span> <span class="n">remove_target_group_ids</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="n">remove_groups</span> <span class="o">=</span> <span class="n">rgroups</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remove_target_group_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">remove_groups</span> <span class="o">=</span> <span class="n">remove_target_group_ids</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remove_target_group_ids</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">remove_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">remove_target_group_ids</span><span class="p">]</span>

            <span class="c1"># Parse add_groups</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">add_target_group_ids</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">add_groups</span> <span class="o">=</span> <span class="n">add_target_group_ids</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">add_target_group_ids</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="n">add_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">add_target_group_ids</span><span class="p">]</span>

            <span class="c1"># seems extraneous with list?</span>
            <span class="c1"># if not remove_groups and not add_groups:</span>
            <span class="c1">#     continue</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">remove_groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">rgroups</span><span class="p">:</span>
                    <span class="n">rgroups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">add_groups</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rgroups</span><span class="p">:</span>
                    <span class="n">rgroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rgroups</span><span class="p">:</span>
                <span class="n">rgroups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isolation_group</span><span class="p">)</span>

            <span class="n">return_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rgroups</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">return_groups</span></div></div>


<div class="viewcode-block" id="EventAction"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.EventAction">[docs]</a><span class="k">class</span> <span class="nc">EventAction</span><span class="p">(</span><span class="n">BaseAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Actions which receive lambda event if present</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="LambdaInvoke"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.LambdaInvoke">[docs]</a><span class="k">class</span> <span class="nc">LambdaInvoke</span><span class="p">(</span><span class="n">EventAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Invoke an arbitrary lambda</span>

<span class="sd">    serialized invocation parameters</span>

<span class="sd">     - resources / collection of resources</span>
<span class="sd">     - policy / policy that is invoke the lambda</span>
<span class="sd">     - action / action that is invoking the lambda</span>
<span class="sd">     - event / cloud trail event if any</span>
<span class="sd">     - version / version of custodian invoking the lambda</span>

<span class="sd">    We automatically batch into sets of 250 for invocation,</span>
<span class="sd">    We try to utilize async invocation by default, this imposes</span>
<span class="sd">    some greater size limits of 128kb which means we batch</span>
<span class="sd">    invoke.</span>

<span class="sd">    Example::</span>

<span class="sd">     - type: invoke-lambda</span>
<span class="sd">       function: my-function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">type_schema</span><span class="p">(</span>
        <span class="s1">&#39;invoke-lambda&#39;</span><span class="p">,</span>
        <span class="n">function</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
        <span class="k">async</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span>
        <span class="n">qualifier</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">},</span>
        <span class="n">required</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,))</span>

<div class="viewcode-block" id="LambdaInvoke.get_permissions"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.LambdaInvoke.get_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;lambda:InvokeAsync&#39;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;lambda:Invoke&#39;</span><span class="p">,)</span></div>

    <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;lambda:InvokeFunction&#39;</span><span class="p">,)</span>

<div class="viewcode-block" id="LambdaInvoke.process"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.LambdaInvoke.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">local_session</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">session_factory</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;lambda&#39;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">FunctionName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;function&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;qualifier&#39;</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Qualifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Qualifier&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;InvocationType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Event&#39;</span>

        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="n">VERSION</span><span class="p">,</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s1">&#39;policy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">resource_set</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="mi">250</span><span class="p">)):</span>
            <span class="n">payload</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_set</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Payload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Payload&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;Payload&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div></div>


<div class="viewcode-block" id="Notify"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Notify">[docs]</a><span class="k">class</span> <span class="nc">Notify</span><span class="p">(</span><span class="n">EventAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flexible notifications require quite a bit of implementation support</span>
<span class="sd">    on pluggable transports, templates, address resolution, variable</span>
<span class="sd">    extraction, batch periods, etc.</span>

<span class="sd">    For expedience and flexibility then, we instead send the data to</span>
<span class="sd">    an sqs queue, for processing. ie. actual communications is DIY atm.</span>

<span class="sd">    Example::</span>

<span class="sd">      policies:</span>
<span class="sd">        - name: ec2-bad-instance-kill</span>
<span class="sd">          resource: ec2</span>
<span class="sd">          filters:</span>
<span class="sd">           - Name: bad-instance</span>
<span class="sd">          actions:</span>
<span class="sd">           - terminate</span>
<span class="sd">           - type: notify</span>
<span class="sd">             to:</span>
<span class="sd">              - event-user</span>
<span class="sd">              - resource-creator</span>
<span class="sd">              - email@address</span>
<span class="sd">             # which template for the email should we use</span>
<span class="sd">             template: policy-template</span>
<span class="sd">             transport:</span>
<span class="sd">               type: sqs</span>
<span class="sd">               region: us-east-1</span>
<span class="sd">               queue: xyz</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">C7N_DATA_MESSAGE</span> <span class="o">=</span> <span class="s2">&quot;maidmsg/1.0&quot;</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;transport&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">],</span>
        <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;notify&#39;</span><span class="p">]},</span>
            <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
            <span class="s1">&#39;to_from&#39;</span><span class="p">:</span> <span class="n">ValuesFrom</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
            <span class="s1">&#39;cc&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}},</span>
            <span class="s1">&#39;cc_from&#39;</span><span class="p">:</span> <span class="n">ValuesFrom</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
            <span class="s1">&#39;cc_manager&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span>
            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
            <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
            <span class="s1">&#39;transport&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;oneOf&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;queue&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;queue&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sqs&#39;</span><span class="p">]}}},</span>
                    <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">],</span>
                     <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
                         <span class="s1">&#39;topic&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sns&#39;</span><span class="p">]},</span>
                     <span class="p">}}]</span>
            <span class="p">},</span>
            <span class="s1">&#39;assume_role&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">250</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Notify</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">manager</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assume_role</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assume_role&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Notify.get_permissions"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Notify.get_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transport&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;sns&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;sns:Publish&#39;</span><span class="p">,)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;transport&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;sqs&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;sqs&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;sqs:SendMessage&#39;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="p">()</span></div>

<div class="viewcode-block" id="Notify.expand_variables"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Notify.expand_variables">[docs]</a>    <span class="k">def</span> <span class="nf">expand_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;expand any variables in the action to_from/cc_from fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;to_from&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">to_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;to_from&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">to_from</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_from</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;expr&#39;</span> <span class="ow">in</span> <span class="n">to_from</span><span class="p">:</span>
                <span class="n">to_from</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_from</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">message</span><span class="p">)</span>
            <span class="n">p</span><span class="p">[</span><span class="s1">&#39;to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValuesFrom</span><span class="p">(</span><span class="n">to_from</span><span class="p">)</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;cc_from&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">cc_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;cc_from&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cc_from</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_from</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;expr&#39;</span> <span class="ow">in</span> <span class="n">cc_from</span><span class="p">:</span>
                <span class="n">cc_from</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_from</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">message</span><span class="p">)</span>
            <span class="n">p</span><span class="p">[</span><span class="s1">&#39;cc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ValuesFrom</span><span class="p">(</span><span class="n">cc_from</span><span class="p">)</span><span class="o">.</span><span class="n">get_values</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="Notify.process"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Notify.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s1">&#39;iam&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">list_account_aliases</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;AccountAliases&#39;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">account_name</span> <span class="o">=</span> <span class="n">aliases</span> <span class="ow">and</span> <span class="n">aliases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="n">event</span><span class="p">,</span>
            <span class="s1">&#39;account_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">account_id</span><span class="p">,</span>
            <span class="s1">&#39;account&#39;</span><span class="p">:</span> <span class="n">account_name</span><span class="p">,</span>
            <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">region</span><span class="p">,</span>
            <span class="s1">&#39;policy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">data</span><span class="p">}</span>
        <span class="n">message</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_variables</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">message</span><span class="p">[</span><span class="s1">&#39;resources&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span>
            <span class="n">receipt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_data_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;sent message:</span><span class="si">%s</span><span class="s2"> policy:</span><span class="si">%s</span><span class="s2"> template:</span><span class="si">%s</span><span class="s2"> count:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">receipt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)))</span></div>

<div class="viewcode-block" id="Notify.send_data_message"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Notify.send_data_message">[docs]</a>    <span class="k">def</span> <span class="nf">send_data_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sqs&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_sqs</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;sns&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_sns</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>

<div class="viewcode-block" id="Notify.send_sns"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Notify.send_sns">[docs]</a>    <span class="k">def</span> <span class="nf">send_sns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">][</span><span class="s1">&#39;topic&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">topic</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;arn:aws:sns&#39;</span><span class="p">):</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">region</span> <span class="o">=</span> <span class="n">topic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">topic_arn</span> <span class="o">=</span> <span class="n">topic</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">]</span>
            <span class="n">topic_arn</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:sns:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">message</span><span class="p">[</span><span class="s1">&#39;region&#39;</span><span class="p">],</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;account_id&#39;</span><span class="p">],</span> <span class="n">topic</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">session_factory</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">assume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_role</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sns&#39;</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">TopicArn</span><span class="o">=</span><span class="n">topic_arn</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">))))</span></div>

<div class="viewcode-block" id="Notify.send_sqs"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.Notify.send_sqs">[docs]</a>    <span class="k">def</span> <span class="nf">send_sqs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;transport&#39;</span><span class="p">][</span><span class="s1">&#39;queue&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">queue</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://sqs.&#39;</span><span class="p">):</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">queue_url</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="k">elif</span> <span class="n">queue</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;arn:sqs&#39;</span><span class="p">):</span>
            <span class="n">queue_arn_split</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">queue_arn_split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">owner_id</span> <span class="o">=</span> <span class="n">queue_arn_split</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">queue_name</span> <span class="o">=</span> <span class="n">queue_arn_split</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">queue_url</span> <span class="o">=</span> <span class="s2">&quot;https://sqs.</span><span class="si">%s</span><span class="s2">.amazonaws.com/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">region</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">region</span>
            <span class="n">owner_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">account_id</span>
            <span class="n">queue_name</span> <span class="o">=</span> <span class="n">queue</span>
            <span class="n">queue_url</span> <span class="o">=</span> <span class="s2">&quot;https://sqs.</span><span class="si">%s</span><span class="s2">.amazonaws.com/</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">region</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">session_factory</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span> <span class="n">assume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assume_role</span><span class="p">)</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;sqs&#39;</span><span class="p">)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;mtype&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;DataType&#39;</span><span class="p">:</span> <span class="s1">&#39;String&#39;</span><span class="p">,</span>
                <span class="s1">&#39;StringValue&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">C7N_DATA_MESSAGE</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span>
            <span class="n">QueueUrl</span><span class="o">=</span><span class="n">queue_url</span><span class="p">,</span>
            <span class="n">MessageBody</span><span class="o">=</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">))),</span>
            <span class="n">MessageAttributes</span><span class="o">=</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;MessageId&#39;</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="AutoTagUser"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.AutoTagUser">[docs]</a><span class="k">class</span> <span class="nc">AutoTagUser</span><span class="p">(</span><span class="n">EventAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tag a resource with the user who created/modified it.</span>

<span class="sd">    .. code-block:: yaml</span>

<span class="sd">      policies:</span>
<span class="sd">        - name: ec2-auto-tag-owner</span>
<span class="sd">          resource: ec2</span>
<span class="sd">          filters:</span>
<span class="sd">           - tag:Owner: absent</span>
<span class="sd">          actions:</span>
<span class="sd">           - type: auto-tag-creator</span>
<span class="sd">             tag: OwnerContact</span>

<span class="sd">    There&#39;s a number of caveats to usage, resources which don&#39;t</span>
<span class="sd">    include tagging as part of their api, may have some delay before</span>
<span class="sd">    automation kicks in to create a tag. Real world delay may be several</span>
<span class="sd">    minutes, with worst case into hours[0]. This creates a race condition</span>
<span class="sd">    between auto tagging and automation.</span>

<span class="sd">    In practice this window is on the order of a fraction of a second, as</span>
<span class="sd">    we fetch the resource and evaluate the presence of the tag before</span>
<span class="sd">    attempting to tag it.</span>

<span class="sd">    References</span>
<span class="sd">     - AWS Config (see REQUIRED_TAGS caveat) - http://goo.gl/oDUXPY</span>
<span class="sd">     - CloudTrail User - http://goo.gl/XQhIG6 q</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">type_schema</span><span class="p">(</span>
        <span class="s1">&#39;auto-tag-user&#39;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">],</span>
        <span class="o">**</span><span class="p">{</span><span class="s1">&#39;user-type&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span>
            <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span>
                          <span class="s1">&#39;IAMUser&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;AssumedRole&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;FederatedUser&#39;</span>
                      <span class="p">]}},</span>
           <span class="s1">&#39;update&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">},</span>
           <span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
           <span class="s1">&#39;principal_id_tag&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">}</span>
           <span class="p">}</span>
    <span class="p">)</span>

<div class="viewcode-block" id="AutoTagUser.get_permissions"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.AutoTagUser.get_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">action_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s1">&#39;tag&#39;</span><span class="p">)({},</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span><span class="o">.</span><span class="n">get_permissions</span><span class="p">()</span></div>

<div class="viewcode-block" id="AutoTagUser.validate"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.AutoTagUser.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;cloudtrail&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Auto tag owner requires an event&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">action_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Resource does not support tagging&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AutoTagUser.process"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.AutoTagUser.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="n">utype</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;userIdentity&#39;</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">utype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user-type&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;AssumedRole&#39;</span><span class="p">,</span> <span class="s1">&#39;IAMUser&#39;</span><span class="p">]):</span>
            <span class="k">return</span>

        <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">utype</span> <span class="o">==</span> <span class="s2">&quot;IAMUser&quot;</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;userIdentity&#39;</span><span class="p">][</span><span class="s1">&#39;userName&#39;</span><span class="p">]</span>
            <span class="n">principal_id_value</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;userIdentity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;principalId&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">utype</span> <span class="o">==</span> <span class="s2">&quot;AssumedRole&quot;</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;userIdentity&#39;</span><span class="p">][</span><span class="s1">&#39;arn&#39;</span><span class="p">]</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">principal_id_value</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;userIdentity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;principalId&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># instance role</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;i-&#39;</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="c1"># lambda function (old style)</span>
            <span class="k">elif</span> <span class="n">user</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;awslambda&#39;</span><span class="p">):</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># if the auto-tag-user policy set update to False (or it&#39;s unset) then we</span>
        <span class="c1"># will skip writing their UserName tag and not overwrite pre-existing values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">untagged_resources</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># iterating over all the resources the user spun up in this event</span>
            <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="n">tag_already_set</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">resource</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Tags&#39;</span><span class="p">,</span> <span class="p">()):</span>
                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]:</span>
                        <span class="n">tag_already_set</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tag_already_set</span><span class="p">:</span>
                    <span class="n">untagged_resources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
        <span class="c1"># if update is set to True, we will overwrite the userName tag even if</span>
        <span class="c1"># the user already set a value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">untagged_resources</span> <span class="o">=</span> <span class="n">resources</span>

        <span class="n">tag_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">action_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag&#39;</span><span class="p">)</span>
        <span class="n">new_tags</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]:</span> <span class="n">user</span>
        <span class="p">}</span>
        <span class="c1"># if principal_id_key is set (and value), we&#39;ll set the principalId tag.</span>
        <span class="n">principal_id_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;principal_id_tag&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">principal_id_key</span> <span class="ow">and</span> <span class="n">principal_id_value</span><span class="p">:</span>
            <span class="n">new_tags</span><span class="p">[</span><span class="n">principal_id_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">principal_id_value</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_tags</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">tag_action</span><span class="p">({</span><span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">untagged_resources</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_tags</span></div></div>


<div class="viewcode-block" id="PutMetric"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.PutMetric">[docs]</a><span class="k">class</span> <span class="nc">PutMetric</span><span class="p">(</span><span class="n">BaseAction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Action to put metrics based on an expression into CloudWatch metrics</span>

<span class="sd">    :example:</span>

<span class="sd">        .. code-block: yaml</span>

<span class="sd">            policies:</span>
<span class="sd">              - name: track-attached-ebs</span>
<span class="sd">                resource: ec2</span>
<span class="sd">                comment: |</span>
<span class="sd">                  Put the count of the number of EBS attached disks to an instance</span>
<span class="sd">                filters:</span>
<span class="sd">                  - Name: tracked-ec2-instance</span>
<span class="sd">                actions:</span>
<span class="sd">                  - type: put-metric</span>
<span class="sd">                    key: Reservations[].Instances[].BlockDeviceMappings[].DeviceName</span>
<span class="sd">                    namespace: Usage Metrics</span>
<span class="sd">                    metric_name: Attached Disks</span>
<span class="sd">                    op: count</span>
<span class="sd">                    units: Files</span>

<span class="sd">    op and units are optional and will default to simple Counts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># permissions are typically lowercase servicename:TitleCaseActionName</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cloudwatch:PutMetricData&#39;</span><span class="p">,</span> <span class="p">}</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;object&#39;</span><span class="p">,</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_name&#39;</span><span class="p">],</span>
        <span class="s1">&#39;properties&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;put-metric&#39;</span><span class="p">,</span> <span class="p">]},</span>
            <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>  <span class="c1"># jmes path</span>
            <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
            <span class="s1">&#39;metric_name&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">},</span>
            <span class="s1">&#39;dimensions&#39;</span><span class="p">:</span>
                <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;array&#39;</span><span class="p">,</span>
                <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span><span class="s1">&#39;object&#39;</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="n">METRIC_OPS</span><span class="o">.</span><span class="n">keys</span><span class="p">()},</span>
            <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;enum&#39;</span><span class="p">:</span> <span class="n">METRIC_UNITS</span><span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<div class="viewcode-block" id="PutMetric.process"><a class="viewcode-back" href="../../generated/c7n.html#c7n.actions.PutMetric.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;namespace&#39;</span><span class="p">]</span>
        <span class="n">metric_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;metric_name&#39;</span><span class="p">]</span>
        <span class="n">key_expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="s1">&#39;Resources[]&#39;</span><span class="p">)</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;op&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)</span>
        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="s1">&#39;Count&#39;</span><span class="p">)</span>
        <span class="c1"># dimensions are passed as a list of dicts</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dimensions&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="c1"># reduce the resources by the key expression, and apply the operation to derive the value</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;searching for </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key_expression</span><span class="p">,</span> <span class="n">resources</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">jmespath</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;Resources[].&quot;</span> <span class="o">+</span> <span class="n">key_expression</span><span class="p">,</span>
                                     <span class="p">{</span><span class="s1">&#39;Resources&#39;</span><span class="p">:</span> <span class="n">resources</span><span class="p">})</span>
            <span class="c1"># I had to wrap resourses in a dict like this in order to not have jmespath expressions</span>
            <span class="c1"># start with [] in the yaml files.  It fails to parse otherwise.</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">oops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">oops</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">METRIC_OPS</span><span class="p">[</span><span class="n">operation</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Bad op for put-metric action: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>

        <span class="c1"># for demo purposes</span>
        <span class="c1"># from math import sin, pi</span>
        <span class="c1"># value = sin((now.minute * 6 * 4 * pi) / 180) * ((now.hour + 1) * 4.0)</span>

        <span class="n">metrics_data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;MetricName&#39;</span><span class="p">:</span> <span class="n">metric_name</span><span class="p">,</span>
                <span class="s1">&#39;Dimensions&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
                               <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dimensions</span>
                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span>
                <span class="s1">&#39;Timestamp&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
                <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                <span class="c1"># TODO: support an operation of &#39;stats&#39; to include this</span>
                <span class="c1"># structure instead of a single Value</span>
                <span class="c1"># Value and StatisticValues are mutually exclusive.</span>
                <span class="c1"># &#39;StatisticValues&#39;: {</span>
                <span class="c1">#     &#39;SampleCount&#39;: 1,</span>
                <span class="c1">#     &#39;Sum&#39;: 123.0,</span>
                <span class="c1">#     &#39;Minimum&#39;: 123.0,</span>
                <span class="c1">#     &#39;Maximum&#39;: 123.0</span>
                <span class="c1"># },</span>
                <span class="s1">&#39;Unit&#39;</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">]</span>

        <span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">session_factory</span><span class="p">()</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;cloudwatch&#39;</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">put_metric_data</span><span class="p">(</span><span class="n">Namespace</span><span class="o">=</span><span class="n">ns</span><span class="p">,</span> <span class="n">MetricData</span><span class="o">=</span><span class="n">metrics_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">resources</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Capital One Services, LLC.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/js/expand.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>